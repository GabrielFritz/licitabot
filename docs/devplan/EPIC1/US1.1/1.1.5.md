# [1.1.5] Salvar os dados extraÃ­dos no PostgreSQL [DONE]

---

## ğŸ¯ Objetivo

Implementar a **persistÃªncia** dos dados extraÃ­dos da API PNCP no PostgreSQL:

1. **ServiÃ§o de persistÃªncia** (`services.persistence`) para salvar dados no banco
2. **IntegraÃ§Ã£o com ingestÃ£o** para salvar automaticamente os dados coletados
3. **Tratamento de duplicatas** e upserts inteligentes
4. **ValidaÃ§Ã£o bÃ¡sica** de dados antes da persistÃªncia
5. **Logs estruturados** de operaÃ§Ãµes de banco

### Fluxo de PersistÃªncia

1. **Dados coletados** pela `ingest_window()` â†’ **ServiÃ§o de persistÃªncia**
2. **Upsert inteligente** (insert/update baseado em chaves Ãºnicas)
3. **TransaÃ§Ãµes** para garantir consistÃªncia
4. **Logs** de operaÃ§Ãµes e mÃ©tricas de performance

> **Foco**: PersistÃªncia robusta e integraÃ§Ã£o com o fluxo de ingestÃ£o. A infraestrutura de banco jÃ¡ foi implementada na tarefa 1.1.4.

---

## âœ… Status: IMPLEMENTADO

### Funcionalidades Implementadas

- âœ… **ServiÃ§o de persistÃªncia** (`services.persistence`)
- âœ… **IntegraÃ§Ã£o com ingestÃ£o** (modificar `ingest_window`)
- âœ… **Upserts inteligentes** (insert/update baseado em chaves Ãºnicas)
- âœ… **Tratamento de duplicatas** e conflitos
- âœ… **Logs estruturados** de operaÃ§Ãµes de banco
- âœ… **Testes de persistÃªncia**
- âœ… **MÃ©tricas de performance** (tempo de salvamento, registros processados)
- âœ… **ConfiguraÃ§Ã£o flexÃ­vel** via variÃ¡veis de ambiente
- âœ… **Modelos de banco otimizados** com `numero_controle_pncp` como chave primÃ¡ria
- âœ… **ConfiguraÃ§Ã£o de logging SQL** para controle de verbosidade
- âœ… **Interface grÃ¡fica** (pgAdmin) para gerenciamento do banco

### Estrutura Final Implementada

```text
pncp_ingestion_service/
â”œâ”€â”€ ingestor/
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ ingestion.py          # JÃ¡ implementado (atualizado com persistÃªncia)
â”‚   â”‚   â””â”€â”€ persistence.py        # NOVO: ServiÃ§o de persistÃªncia (implementado)
â”‚   â”œâ”€â”€ database/
â”‚   â”‚   â”œâ”€â”€ connection.py         # JÃ¡ implementado (atualizado com SQL_LOGGING)
â”‚   â”‚   â”œâ”€â”€ models.py             # JÃ¡ implementado (otimizado com numero_controle_pncp)
â”‚   â”‚   â””â”€â”€ repositories/         # NOVO: RepositÃ³rios para cada entidade (implementado)
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â”œâ”€â”€ orgao_repository.py
â”‚   â”‚       â”œâ”€â”€ unidade_repository.py
â”‚   â”‚       â”œâ”€â”€ contratacao_repository.py
â”‚   â”‚       â””â”€â”€ item_repository.py
â”‚   â””â”€â”€ config.py                 # Atualizado com variÃ¡veis de persistÃªncia e SQL_LOGGING
â”œâ”€â”€ tests/
â”‚   â””â”€â”€ test_persistence.py       # NOVO: Testes de persistÃªncia (implementado)
â”œâ”€â”€ docker-compose.yaml           # Atualizado com pgAdmin e PYTHONUNBUFFERED
â”œâ”€â”€ env.local.example             # Atualizado com variÃ¡veis de persistÃªncia
â””â”€â”€ requirements.txt              # Atualizado com dependÃªncias
```

### Componentes Implementados

#### **1. RepositÃ³rios (`database/repositories/`)**
- âœ… `OrgaoRepository` - Upsert de Ã³rgÃ£os baseado no CNPJ
- âœ… `UnidadeRepository` - Upsert de unidades baseado no cÃ³digo
- âœ… `ContratacaoRepository` - Upsert de contrataÃ§Ãµes e relacionamentos
- âœ… `ItemRepository` - Upsert em lote de itens

#### **2. ServiÃ§o de PersistÃªncia (`services/persistence.py`)**
- âœ… `persist_contratacao_with_items()` - PersistÃªncia completa de contrataÃ§Ã£o
- âœ… `PersistenceResult` - Modelo de resultado estruturado (atualizado para usar `numero_controle_pncp`)
- âœ… `format_persistence_log()` - FormataÃ§Ã£o de logs informativos
- âœ… Tratamento de transaÃ§Ãµes e rollback automÃ¡tico
- âœ… Logs detalhados com mÃ©tricas de performance
- âœ… **ConfiguraÃ§Ã£o de timeout** via variÃ¡veis de ambiente

#### **3. IntegraÃ§Ã£o com IngestÃ£o**
- âœ… ModificaÃ§Ã£o de `services/ingestion.py` para chamar persistÃªncia
- âœ… Logs estruturados com informaÃ§Ãµes de sucesso/erro
- âœ… Tratamento de exceÃ§Ãµes durante persistÃªncia

#### **4. ConfiguraÃ§Ã£o (`config.py`)**
- âœ… `PERSISTENCE_BATCH_SIZE` - Tamanho do lote para upserts
- âœ… `PERSISTENCE_TIMEOUT` - Timeout para operaÃ§Ãµes de banco
- âœ… `PERSISTENCE_RETRY_ATTEMPTS` - Tentativas de retry
- âœ… `SQL_LOGGING` - Controle de verbosidade de logs SQL

#### **5. Modelos de Banco (`database/models.py`)**
- âœ… **OtimizaÃ§Ã£o de chaves primÃ¡rias**: `numero_controle_pncp` como PK para `Contratacao`
- âœ… **Foreign keys atualizadas**: Todos os relacionamentos usam `numero_controle_pncp`
- âœ… **EliminaÃ§Ã£o de problemas de ID**: NÃ£o hÃ¡ mais necessidade de capturar IDs auto-gerados
- âœ… **Melhor performance**: Chaves naturais e significativas

#### **6. ConfiguraÃ§Ã£o de Docker**
- âœ… `PYTHONUNBUFFERED=1` - Logs Python imediatos
- âœ… `pgAdmin` - Interface grÃ¡fica para gerenciamento do banco
- âœ… **Controle de verbosidade**: `SQL_LOGGING=false` por padrÃ£o

#### **7. Testes**
- âœ… `test_persistence.py` - Testes do serviÃ§o de persistÃªncia
- âœ… Cobertura de casos de sucesso e erro
- âœ… Testes de formataÃ§Ã£o de logs

### Logs Implementados

```text
[PERSIST] âœ“ 88073291000199-1-000115/2025 â€” 10 itens salvos (orgao:âœ“, unidade:âœ“, amparo:âœ“, duration:110ms)
[PERSIST] âš ï¸  07854402000100-1-000055/2025 â€” 3 itens salvos, 1 erro: "CNPJ invÃ¡lido"
[PERSIST] âŒ 07854402000100-1-000056/2025 â€” Falha: "Timeout na conexÃ£o com banco"
```

### EvidÃªncia de Funcionamento

```text
[*] Initializing database tables...
[*] Database tables created successfully
[*] Listening on ingest.pncp â€¦  Ctrl-C para sair
[ingestor] mode=update  window=2025-07-12T17:19:45 â†’ 2025-07-12T17:34:45  (Î”=900s)
[PERSIST] âœ“ 88073291000199-1-000115/2025 â€” 10 itens salvos (orgao:âœ“, unidade:âœ“, amparo:âœ“, duration:110ms)
```

---

## ğŸ“‹ EspecificaÃ§Ãµes TÃ©cnicas

### **1. ServiÃ§o de PersistÃªncia (`services.persistence`)**

```python
async def persist_contratacao_with_items(
    contratacao: Contratacao,
    itens: List[ItemContratacao]
) -> PersistenceResult:
    """
    Persiste uma contrataÃ§Ã£o com todos os seus itens.
    
    Fluxo:
    1. Upsert Ã³rgÃ£o e unidade
    2. Upsert amparo legal e fontes orÃ§amentÃ¡rias
    3. Upsert contrataÃ§Ã£o
    4. Upsert todos os itens
    5. Commit transaÃ§Ã£o
    """
```

### **2. RepositÃ³rios (`database/repositories/`)**

```python
class OrgaoRepository:
    async def upsert(self, orgao: OrgaoEntidade) -> OrgaoEntidade:
        """Upsert Ã³rgÃ£o baseado no CNPJ."""

class UnidadeRepository:
    async def upsert(self, unidade: UnidadeOrgao) -> UnidadeOrgao:
        """Upsert unidade baseado no cÃ³digo."""

class ContratacaoRepository:
    async def upsert(self, contratacao: Contratacao) -> Contratacao:
        """Upsert contrataÃ§Ã£o baseado no numero_controle_pncp."""

class ItemRepository:
    async def upsert_batch(self, itens: List[ItemContratacao]) -> List[ItemContratacao]:
        """Upsert lote de itens."""
```

### **3. Modelo de Resultado**

```python
@dataclass
class PersistenceResult:
    success: bool
    numero_controle_pncp: Optional[str] = None  # Atualizado: usa string em vez de int
    itens_saved: int = 0
    orgao_upserted: bool = False
    unidade_upserted: bool = False
    amparo_upserted: bool = False
    fontes_upserted: int = 0
    duration_ms: float = 0.0
    errors: List[str] = field(default_factory=list)
```

### **4. ConfiguraÃ§Ã£o de Ambiente**

```bash
# Persistence Configuration
PERSISTENCE_BATCH_SIZE=100
PERSISTENCE_TIMEOUT=30.0
PERSISTENCE_RETRY_ATTEMPTS=3

# Logging Configuration
SQL_LOGGING=false  # Controla verbosidade de logs SQL
LOG_LEVEL=INFO
PYTHONUNBUFFERED=1  # Logs Python imediatos
```

### **5. Modelos de Banco Otimizados**

```python
class Contratacao(Base):
    __tablename__ = "contratacoes"
    
    numero_controle_pncp = Column(String(100), primary_key=True)  # Chave primÃ¡ria natural
    # ... outros campos

class ItemContratacao(Base):
    __tablename__ = "itens_contratacao"
    
    numero_controle_pncp = Column(String(100), ForeignKey("contratacoes.numero_controle_pncp"))
    # ... outros campos
```

### **6. IntegraÃ§Ã£o com IngestÃ£o**

```python
# Em services/ingestion.py
async def ingest_window() -> None:
    """Executa ingestÃ£o de dados do PNCP."""
    # ... cÃ³digo de coleta ...
    
    # Persistir dados coletados
    for contratacao in contratacoes:
        result = await persist_contratacao_with_items(contratacao, itens)
        log.info(format_persistence_log(result, contratacao.numero_controle_pncp))
```

---

## ğŸ”§ ImplementaÃ§Ã£o

### **1. RepositÃ³rios**

Cada repositÃ³rio implementa:
- **Upsert inteligente** baseado em chaves Ãºnicas
- **Tratamento de duplicatas** e conflitos
- **TransaÃ§Ãµes** para garantir consistÃªncia
- **Logs** de operaÃ§Ãµes de banco

### **2. ServiÃ§o de PersistÃªncia**

- **OrquestraÃ§Ã£o** de todos os repositÃ³rios
- **TransaÃ§Ãµes** para garantir atomicidade
- **Rollback automÃ¡tico** em caso de erro
- **MÃ©tricas** de performance e logs estruturados

### **3. IntegraÃ§Ã£o**

- **ModificaÃ§Ã£o** de `services/ingestion.py`
- **Chamada** do serviÃ§o de persistÃªncia
- **Logs** informativos de sucesso/erro
- **Tratamento** de exceÃ§Ãµes durante persistÃªncia

### **4. OtimizaÃ§Ãµes de Banco**

- **Chaves primÃ¡rias naturais**: `numero_controle_pncp` como PK
- **EliminaÃ§Ã£o de problemas de ID**: NÃ£o hÃ¡ mais necessidade de capturar IDs
- **Melhor performance**: Chaves significativas e Ãºnicas
- **Controle de verbosidade**: `SQL_LOGGING` para logs limpos

---

## âœ… Testes

### **1. Testes de PersistÃªncia**

```bash
# Executar testes
python -m pytest tests/test_persistence.py -v
```

### **2. Cobertura de Testes**

- âœ… **Casos de sucesso** - PersistÃªncia completa
- âœ… **Casos de erro** - Tratamento de exceÃ§Ãµes
- âœ… **Upserts** - VerificaÃ§Ã£o de duplicatas
- âœ… **TransaÃ§Ãµes** - Rollback em caso de erro
- âœ… **Logs** - FormataÃ§Ã£o correta de mensagens
- âœ… **Modelos atualizados** - Testes com `numero_controle_pncp`

---

## ğŸ“Š MÃ©tricas

### **1. Performance**

- **Tempo mÃ©dio** de persistÃªncia por contrataÃ§Ã£o
- **NÃºmero de itens** salvos por operaÃ§Ã£o
- **Taxa de sucesso** das operaÃ§Ãµes de banco

### **2. Logs**

- **Formato estruturado** com informaÃ§Ãµes detalhadas
- **MÃ©tricas de performance** (tempo, registros processados)
- **Tratamento de erros** com mensagens informativas
- **Controle de verbosidade** SQL para logs limpos

---

## ğŸ› ï¸ Ferramentas de Gerenciamento

### **1. pgAdmin (Interface GrÃ¡fica)**
- **URL**: http://localhost:8080
- **Credenciais**: admin@pncp.com / admin123
- **Funcionalidades**: VisualizaÃ§Ã£o de dados, queries SQL, exportaÃ§Ã£o

### **2. ConfiguraÃ§Ã£o de Logs**
- **SQL_LOGGING=false**: Logs limpos sem verbosidade SQL
- **PYTHONUNBUFFERED=1**: Logs Python imediatos
- **LOG_LEVEL=INFO**: NÃ­vel apropriado de detalhamento

---

## ğŸš€ PrÃ³ximos Passos

1. **Testes de integraÃ§Ã£o** com dados reais da API
2. **OtimizaÃ§Ã£o de performance** para grandes volumes
3. **Monitoramento** de mÃ©tricas de persistÃªncia
4. **Backup e recuperaÃ§Ã£o** de dados
5. **Ãndices** para otimizar consultas frequentes
6. **Dashboards** para visualizaÃ§Ã£o de mÃ©tricas
7. **Alertas** para falhas de persistÃªncia
