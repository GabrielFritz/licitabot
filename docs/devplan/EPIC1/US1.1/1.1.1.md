# [1.1.1] Criar worker ingestor com consumer.py para escutar fila RabbitMQ

---

## ðŸŽ¯ Objetivo

Criar um micro-serviÃ§o **desacoplado** (pode rodar via `python consumer.py` ou em container dedicado) que:

1. **Escute** a fila **`ingest.pncp`** no RabbitMQ.  
2. Ao receber mensagem JSON:

   | Payload | Significado | Janela usada |
   |---------|-------------|--------------|
   | `{}` ou `{"mode":"update"}` | **Update** padrÃ£o | Ãºltimos **ROLLING_WINDOW_MINUTES** (env, default = 15 min) |
   | `{"mode":"backfill", "data_ini":"YYYY-MM-DDTHH:MM:SS", "data_fim":"YYYY-MM-DDTHH:MM:SS"}` | **Back-fill** manual | intervalo explÃ­cito |

3. Dispare o fluxo de ingestÃ£o (`services.ingestion.ingest_window`):  
   1. Chame **`GET /consulta/v1/contratacoes/atualizacao`** com:  
      - `codigoModalidadeContratacao = 6` (PregÃ£o EletrÃ´nico)  
      - `dataInicial`, `dataFinal` em **AAAAMMDD** (os **dias** que cobrem a janela)  
      - `tamanhoPagina = 100`  
   2. Descubra `totalPaginas` e **iterar da Ãºltima â†’ primeira** (mais recentes primeiro).  
   3. Dentro da pÃ¡gina, percorrer **de baixo para cima** (registro final Ã© o mais novo).  
   4. Para cada contrataÃ§Ã£o (`numeroControlePNCP`) **dentro da janela em segundos**:  
      - Decompor `numeroControlePNCP` â†’ **`cnpj` / `ano` / `sequencial`**  
      - Chamar **`/pncp/v1/orgaos/{cnpj}/compras/{ano}/{sequencial}/itens`** para coletar **todos os itens**.  
      - **Logar dados coletados** (prÃ³ximo passo: persistir no Postgres ou publicar em nova fila `ingest.persist`).

> **Filtragem em segundos** ocorre **em memÃ³ria** usando `dataAtualizacaoGlobal`; assim evitamos re-processar pÃ¡ginas antigas.

---

## âœ… Status: IMPLEMENTADO

### Funcionalidades Implementadas:
- âœ… **Consumer RabbitMQ** com `aio-pika` para escuta assÃ­ncrona
- âœ… **Modos update/backfill** com janelas temporais configurÃ¡veis
- âœ… **PaginaÃ§Ã£o inteligente** da API PNCP (Ãºltima â†’ primeira pÃ¡gina)
- âœ… **Filtragem em memÃ³ria** por `dataAtualizacaoGlobal`
- âœ… **Coleta de itens** para cada contrataÃ§Ã£o
- âœ… **Modelos Pydantic** para validaÃ§Ã£o de dados
- âœ… **ConfiguraÃ§Ã£o centralizada** com variÃ¡veis de ambiente
- âœ… **Testes automatizados** (utils, RabbitMQ, desenvolvimento local)
- âœ… **Docker Compose** para desenvolvimento local
- âœ… **Scripts de automaÃ§Ã£o** (`start_local.sh`)
- âœ… **Logs estruturados** com informaÃ§Ãµes de performance
- âœ… **Retry logic** com `tenacity` para rate limiting
- âœ… **DocumentaÃ§Ã£o completa** com README detalhado

### Estrutura Final Implementada:
```text
pncp_ingestion_service/
â”œâ”€â”€ ingestor/
â”‚   â”œâ”€â”€ consumer.py          # Worker RabbitMQ (implementado)
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ ingestion.py     # LÃ³gica de ingestÃ£o (implementado)
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â””â”€â”€ pncp.py          # Modelos Pydantic (implementado)
â”‚   â”œâ”€â”€ utils.py             # FunÃ§Ãµes auxiliares (implementado)
â”‚   â””â”€â”€ config.py            # ConfiguraÃ§Ã£o centralizada (implementado)
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ test_utils.py        # Testes das funÃ§Ãµes utils (implementado)
â”‚   â”œâ”€â”€ test_rabbitmq.py     # Teste de conexÃ£o RabbitMQ (implementado)
â”‚   â”œâ”€â”€ test_local.py        # Teste para desenvolvimento local (implementado)
â”‚   â””â”€â”€ run_all_tests.py     # Executor de todos os testes (implementado)
â”œâ”€â”€ requirements.txt          # DependÃªncias Python (implementado)
â”œâ”€â”€ docker-compose.yaml       # OrquestraÃ§Ã£o local (implementado)
â”œâ”€â”€ Dockerfile               # ContainerizaÃ§Ã£o (implementado)
â”œâ”€â”€ start_local.sh           # Script de inicializaÃ§Ã£o (implementado)
â””â”€â”€ README.md               # DocumentaÃ§Ã£o completa (implementado)
```

---

## ðŸ“¦ DependÃªncias Implementadas

| Biblioteca | Uso principal | Status |
|------------|---------------|--------|
| **aio_pika** | Consumir fila RabbitMQ de forma assÃ­ncrona | âœ… Implementado |
| **httpx**   | RequisiÃ§Ãµes assÃ­ncronas Ã  API PNCP | âœ… Implementado |
| **pydantic**| ValidaÃ§Ã£o/serializaÃ§Ã£o de payloads PNCP (`models/pncp.py`) | âœ… Implementado |
| **tenacity** | Retry logic para rate limiting da API | âœ… Implementado |
| **SQLAlchemy** | PersistÃªncia (em tarefas futuras) | âœ… Preparado |
| **asyncpg** / **psycopg2** | Driver Postgres (tarefas futuras) | âœ… Preparado |

---

## ðŸ”„ PrÃ³ximos Passos (Tarefas Futuras)

- [ ] **PersistÃªncia no PostgreSQL** - Implementar armazenamento dos dados coletados
- [ ] **PublicaÃ§Ã£o em fila `ingest.persist`** - Enviar dados processados para prÃ³xima etapa
- [ ] **MÃ©tricas e monitoramento** - Prometheus/Grafana para observabilidade
- [ ] **Tratamento de erros robusto** - Circuit breakers e dead letter queues
- [ ] **Testes de integraÃ§Ã£o** - Testes end-to-end com API PNCP real
- [ ] **CI/CD Pipeline** - AutomatizaÃ§Ã£o de build e deploy
