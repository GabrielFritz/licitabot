# [1.1.3] Implementar fetch e parse da API do PNCP (somente pregÃµes eletrÃ´nicos)

---

## ğŸ¯ Objetivo

Implementar a **lÃ³gica de ingestÃ£o** que consome a API PNCP para coletar dados de pregÃµes eletrÃ´nicos:

1. **ServiÃ§o de ingestÃ£o** (`services.ingestion.ingest_window`)
2. **Chamadas Ã  API PNCP** com paginaÃ§Ã£o inteligente
3. **Filtragem temporal** em memÃ³ria
4. **Coleta de itens** para cada contrataÃ§Ã£o
5. **Retry logic** para rate limiting
6. **Parsing e validaÃ§Ã£o** dos dados

### Fluxo de IngestÃ£o:

1. **Chamar `GET /consulta/v1/contratacoes/atualizacao`** com:
   - `codigoModalidadeContratacao = 6` (PregÃ£o EletrÃ´nico)
   - `dataInicial`, `dataFinal` em **AAAAMMDD** (dias que cobrem a janela)
   - `tamanhoPagina = 100`

2. **PaginaÃ§Ã£o inteligente**:
   - Descobrir `totalPaginas`
   - Iterar **da Ãºltima â†’ primeira** (mais recentes primeiro)
   - Dentro da pÃ¡gina, percorrer **de baixo para cima** (registro final Ã© o mais novo)

3. **Para cada contrataÃ§Ã£o dentro da janela temporal**:
   - Decompor `numeroControlePNCP` â†’ **`cnpj` / `ano` / `sequencial`**
   - Chamar **`/pncp/v1/orgaos/{cnpj}/compras/{ano}/{sequencial}/itens`**
   - Coletar **todos os itens** da contrataÃ§Ã£o

4. **Filtragem em memÃ³ria** usando `dataAtualizacaoGlobal` para evitar reprocessamento

> **Foco**: LÃ³gica de negÃ³cio, API calls, parsing e validaÃ§Ã£o de dados. A infraestrutura base jÃ¡ foi implementada na tarefa 1.1.1.

---

## âœ… Status: IMPLEMENTADO

### Funcionalidades Implementadas:
- âœ… **ServiÃ§o de ingestÃ£o** (`services.ingestion.ingest_window`)
- âœ… **Chamadas assÃ­ncronas** Ã  API PNCP com `httpx`
- âœ… **PaginaÃ§Ã£o inteligente** (Ãºltima â†’ primeira pÃ¡gina)
- âœ… **Filtragem temporal** em memÃ³ria por `dataAtualizacaoGlobal`
- âœ… **Coleta de itens** para cada contrataÃ§Ã£o
- âœ… **Retry logic** com `tenacity` para rate limiting
- âœ… **Modelos Pydantic** para validaÃ§Ã£o de dados da API
- âœ… **Logs estruturados** com informaÃ§Ãµes de performance
- âœ… **Testes de integraÃ§Ã£o** com API real

### Estrutura Implementada:
```text
pncp_ingestion_service/
â”œâ”€â”€ ingestor/
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ ingestion.py     # LÃ³gica de ingestÃ£o (implementado)
â”‚   â””â”€â”€ models/
â”‚       â””â”€â”€ pncp.py          # Modelos Pydantic para API (implementado)
```

---

## ğŸ“¦ DependÃªncias Implementadas

| Biblioteca | Uso principal | Status |
|------------|---------------|--------|
| **httpx**   | RequisiÃ§Ãµes assÃ­ncronas Ã  API PNCP | âœ… Implementado |
| **pydantic**| ValidaÃ§Ã£o/serializaÃ§Ã£o de dados da API | âœ… Implementado |
| **tenacity** | Retry logic para rate limiting | âœ… Implementado |

---

## ğŸ”„ PrÃ³ximos Passos

- [ ] **Tarefa 1.1.4** - Criar estrutura de tabelas no PostgreSQL
- [ ] **Tarefa 1.1.5** - Salvar e normalizar dados extraÃ­dos
- [ ] **PersistÃªncia** - Armazenar dados coletados no banco
- [ ] **PublicaÃ§Ã£o** - Enviar dados para fila `ingest.persist`
