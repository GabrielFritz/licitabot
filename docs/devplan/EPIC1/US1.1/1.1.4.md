# [1.1.4] Criar estrutura de tabelas de ingest√£o no Postgres

---

## üéØ Objetivo

Criar a **estrutura de banco de dados** para armazenar os dados extra√≠dos da API PNCP:

1. **Servi√ßo PostgreSQL** no Docker Compose
2. **Tabelas normalizadas** baseadas nos modelos Pydantic
3. **Scripts de migra√ß√£o** com Alembic
4. **Modelos SQLAlchemy** para ORM
5. **Configura√ß√£o de conex√£o** centralizada
6. **Testes de conectividade** ao banco

### Estrutura de Tabelas Proposta

#### **Tabelas Principais**

- `orgaos_entidades` - √ìrg√£os e entidades
- `unidades_orgaos` - Unidades dos √≥rg√£os  
- `contratacoes` - Contrata√ß√µes principais
- `itens_contratacao` - Itens das contrata√ß√µes

#### **Tabelas de Refer√™ncia**

- `amparos_legais` - Amparo legal das contrata√ß√µes
- `fontes_orcamentarias` - Fontes or√ßament√°rias
- `modalidades_contratacao` - Modalidades de contrata√ß√£o
- `situacoes_compra` - Situa√ß√µes das compras

#### **Tabelas de Relacionamento**

- `contratacoes_fontes_orcamentarias` - N:N entre contrata√ß√µes e fontes

> **Foco**: Infraestrutura de banco, normaliza√ß√£o de dados e prepara√ß√£o para persist√™ncia. A l√≥gica de salvamento ser√° implementada na tarefa 1.1.5.

---

## ‚úÖ Status: IMPLEMENTADO

### Funcionalidades Implementadas

- ‚úÖ **Servi√ßo PostgreSQL** no docker-compose.yaml
- ‚úÖ **Modelos SQLAlchemy** baseados nos Pydantic models
- ‚úÖ **Scripts de migra√ß√£o** com Alembic
- ‚úÖ **Configura√ß√£o de conex√£o** centralizada
- ‚úÖ **Testes de conectividade** ao banco
- ‚úÖ **Documenta√ß√£o** da estrutura de tabelas
- ‚úÖ **Script de inicializa√ß√£o** do banco
- ‚úÖ **Integra√ß√£o** com Docker Compose

### Estrutura Final Implementada

```text
pncp_ingestion_service/
‚îú‚îÄ‚îÄ ingestor/
‚îÇ   ‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ connection.py       # Configura√ß√£o de conex√£o (implementado)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models.py           # Modelos SQLAlchemy (implementado)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ migrations/         # Scripts Alembic (implementado)
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ env.py          # Ambiente Alembic (implementado)
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ script.py.mako  # Template migra√ß√µes (implementado)
‚îÇ   ‚îî‚îÄ‚îÄ config.py               # Configura√ß√£o DB (atualizado)
‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îî‚îÄ‚îÄ init.sql                # Script inicializa√ß√£o (implementado)
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îî‚îÄ‚îÄ init_database.py        # Script inicializa√ß√£o (implementado)
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îî‚îÄ‚îÄ test_database.py        # Testes conectividade (implementado)
‚îú‚îÄ‚îÄ docker-compose.yaml          # PostgreSQL adicionado (atualizado)
‚îú‚îÄ‚îÄ alembic.ini                 # Configura√ß√£o Alembic (implementado)
‚îú‚îÄ‚îÄ requirements.txt             # Depend√™ncias DB (atualizado)
‚îî‚îÄ‚îÄ start_local.sh              # Script inicializa√ß√£o (atualizado)
```

### Modelos SQLAlchemy Implementados

1. **`OrgaoEntidade`** - √ìrg√£os e entidades
2. **`UnidadeOrgao`** - Unidades dos √≥rg√£os
3. **`AmparoLegal`** - Amparo legal das contrata√ß√µes
4. **`FonteOrcamentaria`** - Fontes or√ßament√°rias
5. **`Contratacao`** - Contrata√ß√µes principais
6. **`ItemContratacao`** - Itens das contrata√ß√µes
7. **`ContratacaoFonteOrcamentaria`** - Relacionamento N:N

### Configura√ß√£o Docker Implementada

```yaml
postgres:
  image: postgres:15-alpine
  container_name: pncp-postgres
  environment:
    POSTGRES_DB: pncp_ingestion
    POSTGRES_USER: pncp_user
    POSTGRES_PASSWORD: pncp_pass
  ports:
    - "5432:5432"
  volumes:
    - postgres_data:/var/lib/postgresql/data
    - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql
  healthcheck:
    test: ["CMD-SHELL", "pg_isready -U pncp_user -d pncp_ingestion"]
    interval: 30s
    timeout: 10s
    retries: 3
```

---

## üìä Esquema de Tabelas Detalhado

### **1. Tabela `orgaos_entidades`**

```sql
CREATE TABLE orgaos_entidades (
    id SERIAL PRIMARY KEY,
    cnpj VARCHAR(14) UNIQUE NOT NULL,
    razao_social VARCHAR(255) NOT NULL,
    poder_id VARCHAR(1) NOT NULL,
    esfera_id VARCHAR(1) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### **2. Tabela `unidades_orgaos`**

```sql
CREATE TABLE unidades_orgaos (
    id SERIAL PRIMARY KEY,
    codigo_unidade VARCHAR(50) NOT NULL,
    nome_unidade VARCHAR(255) NOT NULL,
    uf_sigla VARCHAR(2) NOT NULL,
    municipio_nome VARCHAR(255) NOT NULL,
    uf_nome VARCHAR(100),
    codigo_ibge VARCHAR(7),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### **3. Tabela `contratacoes`**

```sql
CREATE TABLE contratacoes (
    id SERIAL PRIMARY KEY,
    numero_controle_pncp VARCHAR(100) UNIQUE NOT NULL,
    srp BOOLEAN NOT NULL,
    
    -- Relacionamentos
    orgao_entidade_id INTEGER REFERENCES orgaos_entidades(id),
    unidade_orgao_id INTEGER REFERENCES unidades_orgaos(id),
    unidade_sub_rogada_id INTEGER REFERENCES unidades_orgaos(id),
    orgao_sub_rogado_id INTEGER REFERENCES orgaos_entidades(id),
    amparo_legal_id INTEGER REFERENCES amparos_legais(id),
    
    -- Datas
    data_inclusao TIMESTAMP NOT NULL,
    data_publicacao_pncp TIMESTAMP NOT NULL,
    data_atualizacao TIMESTAMP NOT NULL,
    data_atualizacao_global TIMESTAMP NOT NULL,
    data_abertura_proposta TIMESTAMP,
    data_encerramento_proposta TIMESTAMP,
    
    -- Identifica√ß√£o
    ano_compra INTEGER NOT NULL,
    sequencial_compra INTEGER NOT NULL,
    numero_compra VARCHAR(100) NOT NULL,
    processo VARCHAR(100) NOT NULL,
    
    -- Modalidade
    modalidade_id INTEGER NOT NULL,
    modalidade_nome VARCHAR(100) NOT NULL,
    modo_disputa_id INTEGER,
    modo_disputa_nome VARCHAR(100),
    
    -- Objeto e valores
    objeto_compra TEXT NOT NULL,
    valor_total_estimado DECIMAL(20,2),
    valor_total_homologado DECIMAL(20,2),
    
    -- Campos livres
    informacao_complementar TEXT,
    justificativa_presencial TEXT,
    
    -- Links
    link_sistema_origem VARCHAR(500),
    link_processo_eletronico VARCHAR(500),
    
    -- Situa√ß√£o
    situacao_compra_id VARCHAR(10) NOT NULL,
    situacao_compra_nome VARCHAR(100) NOT NULL,
    
    -- Instrumento
    tipo_instrumento_convocatorio_codigo INTEGER,
    tipo_instrumento_convocatorio_nome VARCHAR(100),
    
    -- Usu√°rio
    usuario_nome VARCHAR(255) NOT NULL,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### **4. Tabela `itens_contratacao`**

```sql
CREATE TABLE itens_contratacao (
    id SERIAL PRIMARY KEY,
    contratacao_id INTEGER REFERENCES contratacoes(id),
    
    numero_item INTEGER NOT NULL,
    descricao TEXT NOT NULL,
    quantidade DECIMAL(15,3) NOT NULL,
    unidade_medida VARCHAR(50) NOT NULL,
    
    material_ou_servico VARCHAR(10) NOT NULL,
    material_ou_servico_nome VARCHAR(100) NOT NULL,
    
    valor_unitario_estimado DECIMAL(20,2),
    valor_total DECIMAL(20,2),
    
    orcamento_sigiloso BOOLEAN NOT NULL,
    
    -- Categoria e julgamento
    item_categoria_id INTEGER NOT NULL,
    item_categoria_nome VARCHAR(100) NOT NULL,
    criterio_julgamento_id INTEGER NOT NULL,
    criterio_julgamento_nome VARCHAR(100) NOT NULL,
    situacao_compra_item INTEGER NOT NULL,
    situacao_compra_item_nome VARCHAR(100) NOT NULL,
    
    -- Benef√≠cio
    tipo_beneficio INTEGER NOT NULL,
    tipo_beneficio_nome VARCHAR(100) NOT NULL,
    incentivo_produtivo_basico BOOLEAN NOT NULL,
    
    -- Datas
    data_inclusao TIMESTAMP NOT NULL,
    data_atualizacao TIMESTAMP NOT NULL,
    
    tem_resultado BOOLEAN NOT NULL,
    
    -- Margem de prefer√™ncia
    aplicabilidade_margem_preferencia_normal BOOLEAN NOT NULL,
    aplicabilidade_margem_preferencia_adicional BOOLEAN NOT NULL,
    percentual_margem_preferencia_normal DECIMAL(5,2),
    percentual_margem_preferencia_adicional DECIMAL(5,2),
    
    -- Cat√°logo/NCM
    ncm_nbs_codigo VARCHAR(20),
    ncm_nbs_descricao VARCHAR(500),
    catalogo VARCHAR(100),
    categoria_item_catalogo VARCHAR(100),
    catalogo_codigo_item VARCHAR(100),
    
    -- Complementos
    informacao_complementar TEXT,
    tipo_margem_preferencia VARCHAR(100),
    exigencia_conteudo_nacional BOOLEAN NOT NULL,
    
    -- Outros
    patrimonio VARCHAR(100),
    codigo_registro_imobiliario VARCHAR(100),
    imagem INTEGER,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### **5. Tabelas de Refer√™ncia**

```sql
-- Amparos legais
CREATE TABLE amparos_legais (
    id SERIAL PRIMARY KEY,
    codigo INTEGER UNIQUE NOT NULL,
    nome VARCHAR(255) NOT NULL,
    descricao TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Fontes or√ßament√°rias
CREATE TABLE fontes_orcamentarias (
    id SERIAL PRIMARY KEY,
    codigo INTEGER UNIQUE NOT NULL,
    nome VARCHAR(255) NOT NULL,
    descricao TEXT NOT NULL,
    data_inclusao TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Relacionamento N:N
CREATE TABLE contratacoes_fontes_orcamentarias (
    contratacao_id INTEGER REFERENCES contratacoes(id),
    fonte_orcamentaria_id INTEGER REFERENCES fontes_orcamentarias(id),
    PRIMARY KEY (contratacao_id, fonte_orcamentaria_id)
);
```

---

## üì¶ Depend√™ncias Implementadas

| Biblioteca | Uso principal | Status |
|------------|---------------|--------|
| **SQLAlchemy** | ORM para PostgreSQL | ‚úÖ Implementado |
| **Alembic** | Migra√ß√µes de banco | ‚úÖ Implementado |
| **psycopg2-binary** | Driver PostgreSQL | ‚úÖ Implementado |
| **asyncpg** | Driver ass√≠ncrono PostgreSQL | ‚úÖ Implementado |

---

## üîÑ Pr√≥ximos Passos

- [ ] **Tarefa 1.1.5** - Implementar persist√™ncia de dados no PostgreSQL
- [ ] **Tarefa 1.1.6** - Implementar normaliza√ß√£o e limpeza de dados
- [ ] **Tarefa 1.1.7** - Implementar publica√ß√£o para fila de persist√™ncia

---

## üê≥ Configura√ß√£o Docker

### Adicionado ao `docker-compose.yaml`

```yaml
postgres:
  image: postgres:15-alpine
  container_name: pncp-postgres
  environment:
    POSTGRES_DB: pncp_ingestion
    POSTGRES_USER: pncp_user
    POSTGRES_PASSWORD: pncp_pass
  ports:
    - "5432:5432"
  volumes:
    - postgres_data:/var/lib/postgresql/data
    - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql
  healthcheck:
    test: ["CMD-SHELL", "pg_isready -U pncp_user -d pncp_ingestion"]
    interval: 30s
    timeout: 10s
    retries: 3
```

### Volumes

```yaml
volumes:
  postgres_data:
    driver: local
```
